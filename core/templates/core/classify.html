{% extends 'core/base.html' %}
{% block title %}Model Training{% endblock %}

{% block content %}
{% load custom_filters %}

<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow-lg p-5" style="max-width: 600px; width: 100%; border-radius: 20px;">
        <h2 class="text-center fw-bold mb-4">Train Your Models</h2>
        <form method="post" id="ml-form">
            {% csrf_token %}

            <!-- ML Category Selection -->
            <div class="form-group mb-4">
                <label for="ml_category" class="form-label"><strong>Select Machine Learning Category:</strong></label>
                <select id="ml_category" name="ml_category" class="form-select" required>
                    <option value="Classification" {% if ml_category == "Classification" %}selected{% endif %}>Classification</option>
                    <option value="Clustering" {% if ml_category == "Clustering" %}selected{% endif %}>Clustering</option>
                    <option value="Regression" {% if ml_category == "Regression" %}selected{% endif %}>Regression</option>
                </select>
            </div>

            <!-- Target Column Selection (for Classification and Regression) -->
            <div id="target-section" class="form-group mb-4" style="display: {% if ml_category == 'Classification' or ml_category == 'Regression' %}block{% else %}none{% endif %};">
                <label for="target_column" class="form-label"><strong>Select Target Column:</strong></label>
                <select id="target_column" name="target_column" class="form-select">
                    {% for column in columns %}
                        <option value="{{ column }}" {% if column == last_selected_target %}selected{% endif %}>{{ column }}</option>
                    {% endfor %}
                </select>
            </div>
            

            <!-- Model Selection -->
            <div class="form-group mb-4">
                <label for="models" class="form-label"><strong>Select Models:</strong></label>
                <select id="models" name="models" class="form-select" multiple required>
                    {% for model in available_models %}
                        <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">Train Models</button>
        </form>
    </div>
</div>

<!-- Results Section -->
{% if results %}
    <div class="container mt-5">
        <h2 class="text-center mb-4">Model Results</h2>
        <div class="row">
            {% for result in results %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0 text-center">{{ result.model_name }}</h5>
                        </div>
                        <div class="card-body text-center">
                            {% for metric, value in result.metrics.items %}
                                <div class="circular-progress mb-4"
                                     style="--percentage: {{ value }};
                                            --color: 
                                                {% if value <= 40 %}red
                                                {% elif value <= 69 %}orange
                                                {% else %}green{% endif %};">
                                    <span class="percentage">{{ value|floatformat:0 }}%</span>
                                </div>
                                <p><strong>{{ metric }}</strong></p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}

<script>
    // Dynamic Form Behavior
    const mlCategory = document.getElementById('ml_category');
    const targetSection = document.getElementById('target-section');
    const form = document.getElementById('ml-form');

    // Show or hide the target section based on the selected ML category
    mlCategory.addEventListener('change', function () {
        if (this.value === 'Classification' || this.value === 'Regression') {
            targetSection.style.display = 'block';
        } else {
            targetSection.style.display = 'none';
        }
        form.submit(); // Reload the page with the selected ML category
    });
</script>

<!-- Styles for Circular Progress Bars -->
<style>
    .circular-progress {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(
            var(--color) calc(var(--percentage) * 1%),
            #e6e6e6 0
        );
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        margin: 0 auto;
    }

    .circular-progress::before {
        content: "";
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: #fff;
        position: absolute;
    }

    .percentage {
        position: relative;
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
    }

    .mb-4 {
        margin-bottom: 1.5rem;
    }
</style>

{% endblock %}
